---
title: 调用堆栈
---
### 1. 调用堆栈定义
- 调用栈是解释器（比如浏览器中的 JavaScript 解释器）追踪函数执行流的一种机制。当执行环境中调用了多个函数时，通过这种机制，我们能够追踪到哪个函数正在执行，执行的函数体中又调用了哪个函数。
- JavaScript是一门单线程的语言，只有一个调用栈，同一时间只能做一件事。
- 每一个进入调用栈的都称为调用帧。
- 堆栈溢出：达到调用栈最大值。
  
### 2. 执行上下文
执行上下文是评估和执行JavaScript代码的环境的抽象概念，每当JavaScript代码在运行的时候，都是在执行上下文运行。
##### 执行上下文分类：
- 全局执行上下文：创建全局window对象，设置this等于这个全局对象
- 函数执行上下文：每当函数被调用的时候，为该函数创建一个新的上下文
- Eval函数执行上下文：eval函数内部的代码会有自己的执行上下文
##### 创建执行上下文
###### 1. 创建阶段
```javascript
ExecutionContext = {
  ThisBinding = <this value>,
  LexicalEnvironment = { ... },
  VariableEnvironment = { ... },
}
```
1. This 绑定
   在函数执行上下文中，this 的值取决于该函数是如何被调用的。如果它被一个引用对象调用，那么 this 会被设置成那个对象，否则 this 的值被设置为全局对象或者 undefined（在严格模式下）。
   ```javascript
    let foo = {
    baz: function() {
    console.log(this);
    }
    }
    foo.baz();   // 'this' 引用 'foo', 因为 'baz' 被对象 'foo' 调用
    let bar = foo.baz;
    bar();       // 'this' 指向全局 window 对象，因为没有指定引用对象
   ```
2. 创建**词法环境**组件
   词法环境是一种规范类型，基于 ECMAScript 代码的词法嵌套结构来定义标识符和具体变量和函数的关联。一个词法环境由环境记录器和一个可能的引用外部词法环境的空值组成。
    - 词法环境就是一种持有标识符-变量映射的解构
    - 词法环境的内部有环境记录器和外部环境的引用。环境记录器是存储变量和函数声明的实际位置。外部环境的引用意味着它可以访问其父级词法环境。
    - 词法环境包含全局环境和函数环境两种。全局环境的外部环境的引用是null。
    - 环境记录器也分为两种，在全局环境中，环境记录器是对象环境记录器。在函数环境中，环境记录器是声明式环境记录器。
3. 创建**变量环境**组件
    - 变量环境也是一个词法环境，其环境记录器持有变量声明语句在执行上下文中创建的绑定关系。
    - ES6中，词法环境组件和变量环境组件的不同是，前者用于存储函数声明和变量(let和const)，后者只用来存储var变量绑定。
###### 2. 执行阶段

### 3. 操作流程
- 每调用一个函数，解释器就会把该函数的执行上下文添加进调用栈并开始执行。
- 正在调用栈中执行的函数还调用了其它函数，那么新函数也将会被添加进调用栈，一旦这个函数被调用，便会立即执行。
- 当前函数执行完毕后，解释器将其清出调用栈，继续执行当前执行环境下的剩余的代码。
- 当分配的调用栈空间被占满时，会引发“堆栈溢出”错误。
  
### 4.JavaScript引擎
JS引擎主要由两部分组成：
内存堆：进行内存分配
调用栈：代码执行的地方
在代码中有些引擎之外的API，是浏览器提供的Web API，比如DOM、AJAX、setTimeout等

### 5. JavaScript的执行机制
- javascript是一门单线程语言，在最新的HTML5中提出了Web-Worker，但javascript是单线程这一核心仍未改变
- 任务分为同步任务和异步任务两种。同步任务就在主线程执行，异步任务进入Event Table并注册回调函数。
- 当指定的任务完成后，Event Table会将这个函数移入Event Queue
- 主线程任务全部执行完后，去Event Queue读取对应函数，进入主线程执行。
- 不断重复这个过程，形成Event Loop
- js引擎存在monitoring process进程不断的检查主线程执行栈是否为空，一旦为空，就会去Event Queue那里检查是否有等待被调用的函数。

